---
title: 'cmahalanobis: An R Package for Computing the Mahalanobis Distance Between
  Factors'
author: "Flavio Gioia"
date: "2024-05-14"
output:
  html_document:
    df_print: paged
  pdf_document: default
---


## Introduction
We provide an effective and practical tool for calculating the Mahalanobis distance, and we show some applications in real and simulated cases. We illustrate the results with graphs and tables, and we comment on the implications and limitations of our approach. We conclude that the cmahalanobis package is a useful and valuable resource for statistical matching or statistical fusion of data.

## Advantages of the cmahalanobis package
Main advantages of package are easyness of use, well documentation, automatic handling of NA or NaN, automatic plot and the possibility to calculate Mahalanobis distance with more distances using less time.

### Advantages of application, compared to “mahalanobis” function of “stats” package 
We can use “cmahalanobis” package in this example:
```{r}
# Load cmahalanobis package
library(cmahalanobis)
# Load iris dataset
data(iris)
# Split data into three parts
setosa <- subset(iris, Species == "setosa")
setosa <- setosa[,-5] # Remove the column of specie
versicolor <- subset(iris, Species == "versicolor")
versicolor <- versicolor[,-5] # Remove the column of specie
virginica <- subset(iris, Species == "virginica")
virginica <- virginica[,-5] # Remove the column of specie
# Create a list with the three groups of flowers
groups <- list(setosa, versicolor, virginica)
# Calculate mahalanobis distance with the function cmahalanobis
distances <- cmahalanobis(groups)
```
this is the content of “distances”:
```{r}
print(distances)
```
If we use “mahalanobis” function of “stats” package on “groups” list, it will arises this error:

```{r eval=FALSE, include=TRUE}
distances <- mahalanobis(groups)
Error in mahalanobis(groups) : 
  “center” argument is missing, with no default
```

The error we are encountering with the “mahalanobis” function in the “stats” package in R is due to the fact that the function specifically requires a center argument, which represents the center or mean of the data. The “mahalanobis” function calculates the Mahalanobis distance of a set of observations from a given center, using a provided or internally calculated covariance matrix.

Here is how the mahalanobis function is structured:
```{r eval=FALSE, include=TRUE}
mahalanobis(x, center, cov, inverted = FALSE)
```
* **x:** a set of observations (typically a vector or matrix);
* **center:** the center point (mean) from which to calculate the distances (must be provided);
* **cov:** the covariance matrix (if not provided, it is calculated from the data);
* **inverted:** logical. If TRUE, "cov" is supposed to contain the inverse of the covariance matrix.

When using the “mahalanobis” function, you need to specify these arguments. If you do not provide the center argument, R does not know from which center point to calculate the distance and thus returns an error.

The “cmahalanobis” function is more useful in this context because it is designed to work directly with a list of data groups, such as in your case with the flower groups in the iris dataset. Unlike the standard “mahalanobis” function in the stats package, which requires specific arguments like the center and covariance matrix, “cmahalanobis” automatically calculates these metrics internally for each data group in the provided list.

This is why “cmahalanobis” does not raise the error regarding the missing "center" argument:

* **Automation:** the “cmahalanobis” function automates the calculation of mean and covariance matrix for each data group, simplifying the process;
* **Convenience:** you don't need to manually compute the center or covariance matrix for each data group, making the function more convenient for situations where you have multiple data groups to compare;
* **Easy of use:** “cmahalanobis” is easier to use when you want to calculate Mahalanobis distances across multiple data groups without having to handle the calculation details.

In summary, “cmahalanobis” is more useful when working with lists of data groups because it automatically handles the necessary calculations that you would otherwise have to provide manually to the “mahalanobis” function. This makes “cmahalanobis” a more efficient and less error-prone choice in such scenarios.

Now we are going to apply “cmahalanobis” function with simulated data and we will make a comparison with “mahalanobis” function of "stats".

```{r}
# We suppose to have a dataframe with three species and their features
specieA <- data.frame(X1 = rnorm(10), X2 = rnorm(10))
specieB <- data.frame(X1 = rnorm(10), X2 = rnorm(10))
specieC <- data.frame(X1 = rnorm(10), X2 = rnorm(10))
# Calculate Mahalanobis distance between specieA and specieB
centerA <- colMeans(specieA)
covA <- cov(specieA)
distanzaAB <- mahalanobis(specieB, centerA, covA)
# Calculate Mahalanobis distance between specieA and specieC
centerA <- colMeans(specieA)
covA <- cov(specieA)
distanceAC <- mahalanobis(specieC, centerA, covA)
# And so on for each couple of species
```

In this example, to calculate Mahalanobis distance between each couple of species, we should repeat the process to each couple and it could be very labourious if the number of species is high. Instead, with “cmahalanobis” we can calculate Mahalanobis distance only one time:

```{r}
# Create a list with three groups of species
gruppi <- list(specieA, specieB, specieC)
# Calculate Mahalanobis distance with cmahalanobis function
distance <- cmahalanobis(gruppi)
# Visualize the distance matrix
print(distance)
```

Thus, “cmahalanobis” automatically calculates Mahalanobis distance between each couple of groups in the list, supplies a distance matrix that it is easy to interpreter and use to further analysis. This renders “cmahalanobis” a much more pratical and efficient choice when you work with more of two groups of data.

### Advantages of application, compared to “mahalanobis.dist()” function of “StatMatch” package
We imagine we have a medical research dataset that includes clinical measurements from three groups of patients with different medical conditions. Each group has data on variables such as blood pressure, cholesterol levels, body mass index (BMI), and other health indicators. Our goal is to compare these groups to identify significant differences in their health conditions.

Using the “mahalanobis.dist” function from the “StatMatch” package (D'Orazio, 2022), we could calculate the Mahalanobis distance between two groups at a time, for example, between Group 1 and Group 2, and then repeat the process for Group 1 and Group 3, and so on. This would require running the function multiple times and manually combining the results to get a comprehensive view of the distances between all groups.

Example of using “mahalanobis.dist”:

```{r message=FALSE, warning=FALSE}
library(StatMatch)
group1 <- data.frame(a = c(1, 2, 4), b = c(2, 3, 4))
group2 <- data.frame(a = c(1, 3, 16), b = c(1, 2, 4))
group3 <- data.frame(a = c(2, 12, 4), b = c(1, 2, 3))
distance_12 <- mahalanobis.dist(data.x = group1, data.y = group2)
distance_13 <- mahalanobis.dist(data.x = group1, data.y = group3)
# And so on for each pair of groups
```

On the other hand, with “cmahalanobis”, we can calculate all distances at once by providing a distance matrix that compares each group with all the others. This is particularly useful when you have more than two groups to compare and want an overview of the relationships between all groups.

Example of using “cmahalanobis”:

```{r echo=TRUE}
groups <- list(group1, group2, group3)
distances <- cmahalanobis(groups)
print(distances)
```

The 'distances' matrix now contains the Mahalanobis distances between all groups.

In this scenario, “cmahalanobis” is more useful because:

* It reduces the computation time and code complexity required for comparing multiple groups.
* It provides a comprehensive distance matrix in a single operation, making it easier to analyze and visualize the results.
* It automates the calculation of means and covariance matrices for each group, eliminating the need to specify these parameters manually.
This makes “cmahalanobis” an efficient and powerful choice for analyses involving multi-group comparisons in medical research contexts and other fields that require multivariate analysis.

This is the structure of the “mahalanobis.dist” function:

```{r eval=FALSE, include=TRUE}
mahalanobis.dist(data.x, data.y=NULL, vc=NULL)
```

* **data.x:** a matrix or a data frame containing variables that should be used in the computation of the distance between units. Only continuous variables are allowed. Missing values (NA) are not allowed. When only data.x is supplied, the distances between rows of data.x is computed.
* **data.y:** a numeric matrix or data frame with the same variables, of the same type, as those in data.x (only continuous variables are allowed). Dissimilarities between rows of data.x and rows of data.y will be computed. If not provided, by default it is assumed data.y=data.x and only dissimilarities between rows of data.x will be computed.
* **vc:** covariance matrix that should be used in distance computation. If it is not supplied (vc = NULL) it is estimated from the input data. In particular, when vc = NULL and only data.x is supplied then the covariance matrix is estimated from data.x (i.e. vc = var(data.x)). On the contrary when vc = NULL and both data.x and data.y are available then the covariance matrix is estimated on the joined data sets (i.e. vc = var(rbind(data.x, data.y))).

“cmahalanobis” function also allows the calculation in presence of NA and/or NaN.

```{r}
num_observations <- 100
num_variables <- 5
group1 <- data.frame(a = c(1,2,NA,4), b = c(3,4,5,NA))
View(group1)
group2 <- data.frame(a = c(2,5,NA,3), b = c(3,4,5,5))
groups <- list(group1, group2)
distances <- cmahalanobis(groups)
print(distances)
```

```{r}
group1 <- data.frame(a = c(1,2,NaN,4), b = c(3,4,5,NaN))
group2 <- data.frame(a = c(2,5,NaN,3), b = c(3,4,5,5))
groups <- list(group1, group2)
distances <- cmahalanobis(groups)
print(distances)
```

## Advantages on particular dataset 
The “cmahalanobis” package is particularly suitable for datasets that contain multiple groups of multivariate data for which you want to calculate the Mahalanobis distance. Here are some scenarios where “cmahalanobis” proves to be very useful:

* **Biodiversity analysis:** When you have measurements of different species and want to compare their genetic or ecological distances. An example is “iris” dataset (Fisher, 1988).
*	**Quality control:** In industrial contexts, to compare groups of products or processes based on multiple quality metrics. An example is “mtcars” dataset (R Core Team, 2024).
*	**Medical research:** To compare groups of patients based on multiple health indicators or treatment responses. An example is “Human Connectome project” that aims to construct a map of the neural connections of the human brain (Van Essen, et al., 2013). This type of dataset is crucial for studying the neurobiological basis of cognition and gaining a better understanding of neurological disorders.
* **Market analysis:** When analysing customer or product segments based on multiple demographic or behavioral characteristics. An example is “Real Estate Data Marketplace” that analyse the trend of real estate market when related to AI, Internet of Things (IoT), Big Data, Digital Object Identifiers (DOI) and Blockchain (Treleaven, Barnett, Knight, & Serrano, 2021). This type of dataset includes real transacted data and can be used to study trends of real estate market; 
* **Pattern recognition:** In studies that require comparing groups of data to identify patterns or anomalies. An example is “MNIST database” that contains images of handwritten digits (Deng, 2012). It is widely used to train machine learning system for recognition of visual pattern and classification of images.

“cmahalanobis” is useful when you need a function that can automatically handles the calculation of means and covariance matrices for each group, simplifying the process of calculating distances between multiple groups. This makes it an excellent tool for analyses involving multi-group comparisons in a multivariate context.

## Application of cmahalanobis
First, we have to download the “cmahalanobis” package from the CRAN with the following code:

```{r eval=FALSE, include=TRUE}
install.packages(”cmahalanobis”)
```

### Application of cmahalanobis to the iris dataset
Once the download is successful, we can apply our function to the iris dataset which is a built-in dataset in R. The iris dataset contains 150 observations of three species of iris flowers (setosa, versicolor, and virginica), with four variables: sepal length, sepal width, petal length, and petal width. Before we can use our function, we have to create a list of data frames for each species, with the following code:

```{r}
iris_list <- split(iris, iris$Species)
```

This code splits the iris data frame into three data frames, one for each species, and stores them in a list called the “iris_list”. We can print the “iris_list” to visualize its structure and content:

```{r}
# Print iris_list
print(iris_list)
```

Now that we have created our list of dataframes, we can apply the function “cmahalanobis()”.

```{r}
res <- cmahalanobis(iris_list)
```

Then, we use:

```{r}
print(res)
```

This code shows the Mahalanobis distance between each iris species present in the iris dataframe: setosa, versicolor and virginica. The main diagonal of the matrix shows the Mahalanobis distance between each species and itself, which is always 3.9. The other elements of matrix revealed the Mahalanobis distance between the different species. For example: the Mahalanobis distance between setosa and versicolor was 335.19989, instead between versicolor and virginica was 16.88654. This means that the versicolor and virginica species are more similar then the setosa species, according to the variables measured in the iris dataframe. Mahalanobis distance is not symmetric, but depends on the direction in which we can measure the distance between points, because it takes into account the correlations of variables and the ellipsoidal forms of points. If the clouds of points are ellipsoidal, the distance will be greater along the shorter axes and smaller on the longer axes. Thus, the Mahalanobis distance between two points can change if we change the point coordinates.

Now we can construct a plot using ggplot2:

```{r}
# Load the ggplot2 package
library(ggplot2)
# Transform the output matrix into a dataframe
output_df <- as.data.frame (cmahalanobis(iris_list))
# Add a column with the species names
output_df$Species <- rownames(output_df)
# Reshape the data frame from wide to long format
output_df_long <- reshape2::melt(output_df, id.vars = "Species") # Rename the columns
colnames(output_df_long) <- c("Species", "Comparison", "Distance")
# Create a bar plot with ggplot2
ggplot(output_df_long, aes(x = Species, y = Distance,
fill = Comparison)) + geom_bar(stat = "identity" , position = "dodge") +
labs(title = "Mahalanobis distance between iris species" ,
x = "Species", y = "Distance" , fill = "Comparison") + theme_minimal ()
```

Figure 1 shows the same results as those for the matrix, but graphically. The bars representing the Mahalanobis distance between the same species are 3.92000. For example, the distance between setosa and versicolor was shorter then the distance between setosa and virginica on the side of 1, which is the perspective of setosa. On the side 2, that is the perspective of versicolor, we detected that the difference between itself is always 3.92000, and the difference between versicolor and setosa was greater than the difference between versicolor and virginica. With the respect to the size of virginica, the higher distance is between setosa and virginica, between virginica and versicolor is less, and it is 3.92000 for itself. The Mahalanobis distance between a species and itself is always equal to a constant value, which depends on the covariance matrix of the data and the scale of the variables. This value has not a direct interpretation, but rather a relative one. The Mahalanobis distance between a species and itself is the same for all species, but it does not tell us how different the species are from each other. To this end, we need to look at the other values of the matrix or graph, which show the Mahalanobis distance between different species. This distance is not symmetrical, but depends on the direction in which the distance between two points is measured, because it takes into account the correlations between the variables and the ellipsoidal shape of the point cloud. If the point cloud is ellipsoidal, the Mahalanobis distance will be greater along the shorter axes of the ellipsoid and smaller along the longer axes. Thus, the Mahalanobis distance between two points can change if the coordinates of the points are exchanged.

### Application of cmahalanobis to the mtcars dataset
Now I will apply the function “cmahalanobis” to the mtcars dataset using the variable “am”. First, we have to split the data into 0, that is, automatic transmission, and 1, that is, manual transmission, thus:

```{r}
# Create a dataframe where only ”am = 0” is present
auto <- subset(mtcars, am == 0)
# Remove the variable ”am = 0”
auto <- auto [, -9]
# Create a dataframe where only ”am = 1” is present
manual <- subset(mtcars, am == 1)
# Remove the variable ”am = 1”
manual <- manual[, -9]
# Create a list with the two groups of cars
groups <- list(auto, manual)
```

Inside the vector groups:
```{r}
# Print groups
print(groups)
```

Finally we apply:
```{r}
res <- cmahalanobis(groups)
```

Then we create a plot:

```{r}
library(ggplot2) # Load the ggplot2 package
output_df <- as.data.frame(cmahalanobis(groups)) # Transform the output matrix into a dataframe
output_df$Type <- rownames(output_df) # Add a column with the typology of cars
output_df_long <- reshape2::melt(output_df, id.vars = "Type") # Change the type of dataframe from large to long
colnames(output_df_long) <- c("Type", "Comparision", "Distance") # Rename columns
ggplot(output_df_long, aes(x = Type, y = Distance, fill = Comparision)) + geom_bar(stat = "identity", position = "dodge") + labs(title = "Mahalanobis distance between car typologies", x = "Typology", y = "Distance", fill = "Comparision") + theme_minimal() # Create the plot
```

Figure 2 shows that the distance between each factor and itself is always 9.47. We observe that the distance between cars with “am = 0” and cars with “am = 1” is 156, under the perspective of “am = 0”. At am = 1, the distance between “am = 0” and “am = 1” is 735.591909, which is high. Therefore, cars with “am = 1” and with “am = 0” are truly different considering other variables: that is, mpg cyl disp hp drat wt qsec vs gear and carb.

###	Simulation study
Here is an example of a simulation study using the “cmahalanobis” package in R. In this study, we will generate three simulated data groups, each with a set of normally distributed variables, and then calculate the Mahalanobis distance between these groups using the “cmahalanobis” function.

```{r}
# Load cmahalanobis package
library(cmahalanobis)
# Define the number of observations and variables for each groups
num_observations <- 100
num_variables <- 5
# We generate three groups of simulated data with normal distribution
set.seed(123) # For the reproducibility of results
group1 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
group2 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
group3 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
# Create a list of three groups of data
groups <- list(group1, group2, group3)
# Calculate Mahalanobis distance with cmahalanobis function
distances <- cmahalanobis(groups)
# Visualize the distance matrix
print(distances)
```

In this script:

* We used “rnorm” to generate random data normally distributed for each group;
* We created a matrix for each group with  “num_observations” rows and “num_variables” columns;
* We converted each matrix into a dataframe and we stored them in a list;
* We used “cmahalanobis” function to calculate Mahalanobis distance between groups;
* We printed the resulting distance matrix.

```{r}
library(ggplot2) # Load the ggplot2 package
# Transform the output matrix into a dataframe
output_df <- as.data.frame(cmahalanobis(groups)) 
# Add a column with the typology of cars
output_df$Type <- rownames(output_df) 
# Change the type of dataframe from large to long
output_df_long <- reshape2::melt(output_df, id.vars = "Type") 
# Rename columns
colnames(output_df_long) <- c("Type", "Comparision", "Distance")
# Create the plot
ggplot(output_df_long, aes(x = Type, y = Distance, fill = Comparision)) +
 geom_bar(stat = "identity", position = "dodge") +
 labs(title = "Mahalanobis distance between groups", x = "Groups",
      y = "Distance", fill = "Comparision") + theme_minimal() # Create the plot
```

This simulation study can serve as a starting point for more complex analyses, such as group comparisons in biodiversity studies, pattern analysis in multivariate data, or testing the effectiveness of statistical methods on simulated data. We advise that the results will be different each time you run the script due to the random nature of data generation, unless we set a fixed seed using “set.seed”.

## Conclusion
In this work, I have presented my package “cmahalanobis”, which I created to calculate the Mahalanobis distance between two or more groups of multivariate data. The Mahalanobis distance is a measure of dissimilarity between two vectors of multivariate random variables, based on the covariance matrix. This distance is useful for matching or statistical data fusion, i.e., integrating two data sources that refer to the same target population and share some variables. My main goal was to compare the Mahalanobis distances between different types of data and explore patterns and relationships in the data. To create and use my package “cmahalanobis”, I used the programming language R and followed the guidelines for writing R packages provided by CRAN. I implemented my function “cmahalanobis”, which takes a list of data frames as input and returns a matrix with the Mahalanobis distances between the dataframes. I also created documentation for my package using the “roxygen2” package and wrote this paper using packages of Springer Nature. To apply my function “cmahalanobis”, I used three datasets: iris, mtcars, and simulated dataset. The iris dataset contains measurements of sepal and petal length and width for three species of iris. The mtcars dataset contains the characteristics of 32 cars, including the type of transmission. The results showed that the Mahalanobis distance between different types of data varied depending on the considered variables and the direction of comparison. For example, in the iris dataset, the Mahalanobis distance between iris species is greater along shorter axes and smaller along longer axes due to the ellipsoidal shape of the data. Additionally, the Mahalanobis distance between iris species is not a symmetric metric but depends on the reference species. In the mtcars dataset, the Mahalanobis distance between cars with automatic and manual transmission significantly differs, indicating a strong dissimilarity between the two types of cars based on the other measured variables. The simulation study showed the functioning of the package on random data. My conclusions are that the Mahalanobis distance is a useful metric for matching or statistical data fusion because it accounts for variable correlations and ellipsoidal data shapes. However, the Mahalanobis distance also has limitations, such as its asymmetry, which depends on the direction in which we measure the distance between points, and the fact that it does not show the variability or distribution of the Mahalanobis distance or account for possible effects of outliers or multicollinearity. Furthermore, the Mahalanobis distance requires having two or more data sources that share some variables, and these variables should be continuous and normally distributed. These are the challenges or difficulties I encountered in creating and using my “cmahalanobis” package. In the future, I could extend my package to include other functions or options, such as the ability to calculate the Mahalanobis distance with categorical or nonnormal variables, or the ability to visualize the Mahalanobis distance with more informative or interactive plots. I could also apply my package to other datasets or problems, such as classification, clustering, or anomaly detection.

The results in this paper were obtained using: stats (R Core Team, 2024), ggplot2 (Wickham, ggplot2: Elegant Graphics for Data Analysis, 2016), reshape2 (Wickham, Reshaping Data with the reshape Package, 2007), cmahalanobis (Gioia,2024) and packages used are available from the Comprehensive R Archive Network (CRAN) at https://CRAN.R-project.org/. All plots are been created using Rstudio.


## References
Gioia, F. (2024, 03 20). cmahalanobis: A R Package for Computing Mahalanobis Distance Between Factors. doi:http://dx.doi.org/10.2139/ssrn.4774700

R Core Team. (2024). R: A Language and Environment for Statistical Computing. Vienna, Austria. Retrieved from https://www.R-project.org/

Wickham, H. (2007). Reshaping Data with the reshape Package. Journal of Statistical Software, 21(12), 1-20. Retrieved from http://www.jstatsoft.org/v21/i12/

Wickham, H. (2016). ggplot2: Elegant Graphics for Data Analysis. Retrieved from https://ggplot2.tidyverse.org

Treleaven, P., Barnett, J., Knight, A., & Serrano, W. (2021, 11 01). Real Estate Data Marketplace. AI and Ethics, 1, 445-462. doi:10.1007/s43681-021-00053-4

Van Essen, D., Smith, S., Barch, D., Bahrens, T., Yacoub, E., & Ugurbil, K. (2013). The WU-Minn Human Connectome Project: An overview. NeuroImage, 80, 62-69. doi:https://doi.org/10.1016/j.neuroimage.2013.05.041

Deng, L. (2012). TheMNIST Database of Handwritten Digit Images for Machine Learning Research [Best of the Web]. IEEE Signal Processing Magazine, 29(6), 141-142. doi:10.1109/MSP.2012.2211477
