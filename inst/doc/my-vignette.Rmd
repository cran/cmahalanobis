---
title: "cmahalanobis: An R Package for Computing the Mahalanobis Distance Between Factors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cmahalanobis: An R Package for Computing the Mahalanobis Distance Between Factors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  fig.width = 4,
  fig.height = 4,
  out.width = '40%'
)
```


## Introduction

Statistical matching or statistical fusion of data is a technique widely used in various fields, such as impact evaluation, public policy analysis, market research, biostatistics  and others. This technique consists of integrating two data sources that refer to the same target population and that share some variables, but not all. The aim is to obtain a synthetic dataset that contains all the variables of interest from both sources, and that preserves the statistical properties of the original data.

One of the key steps in statistical matching or statistical fusion of data is to ensure the similarity or dissimilarity between the units of two data sources, based on common variables. A common measure of dissimilarity is the Mahalanobis distance, which is a measure of dissimilarity between two vectors of multivariate random variables, based on the covariance matrix. This distance takes into account the correlation between variables, and gives more weight to variables that have more variance.

However, calculating the Mahalanobis distance requires complex mathematical operations, such as inverting the covariance matrix, which can be difficult to implement and computationally expensive, especially when working with large amounts of data or many variables. Furthermore, the calculation of the Mahalanobis distance can be affected by problems such as missing data, nonnormality of variables, or multicollinearity. These problems can lead to inaccurate or unreliable results, and appropriate methods are needed to handle them.

We present the cmahalanobis package, an R package that provides a function to compute the Mahalanobis distance between every pair of species in a list of data frames. Each data frame contains the observations of a species with some variables. The cmahalanobis package is based on the formula for Mahalanobis distance and exploits the Mahalanobis functions of “stats” R package for matrix computation. The cmahalanobis package offers several options for handling missing data, standardizing variables, and selecting relevant variables. The cmahalanobis package differs from other similar packages in terms of its simplicity, flexibility, and speed.

We provide an effective and practical tool for calculating the Mahalanobis distance, and we show some applications in real and simulated cases. We illustrate the results with graphs and tables, and we comment on the implications and limitations of our approach. We conclude that the cmahalanobis package is a useful and valuable resource for statistical matching or statistical fusion of data.

## Advantages of the cmahalanobis package
Main advantages of package are easyness of use, well documentation, automatic handling of NA or NaN, automatic plot and the possibility to calculate Mahalanobis distance with more distances using less time.

Other properties:

* Automation: The “cmahalanobis” function automates the calculation of mean and covariance matrix for each data group, simplifying the process;

*	Convenience: You don't need to manually compute the center or covariance matrix for each data group, making the function more convenient for situations where you have multiple data groups to compare;

*	Ease of use: “cmahalanobis” is easier to use when you want to calculate Mahalanobis distances across multiple data groups without having to handle the calculation details.

* Automatic plot: plots are created just users apply the function to a list of dataframes, if they don't want, they have to specify "plot = FALSE"

* Automatic p-values: p-values are printed just users write the name of the vector where it is been applied the function to a list of dataframes, if they write "p.value = TRUE"

“cmahalanobis” function allows the calculation in presence of NA and/or NaN. Replacing them with a mean of the variable where the value is present.

First, we have to download the “cmahalanobis” package from the CRAN with the following code:

```{r eval=FALSE, include=TRUE}
install.packages(”cmahalanobis”)
```

Then:

```{r}
library(cmahalanobis)
num_observations <- 100
num_variables <- 5
group1 <- data.frame(a = c(1,2,NA,4), b = c(3,4,5,NA))
group2 <- data.frame(a = c(2,5,NA,3), b = c(3,4,5,5))
groups <- list(group1, group2)
distances <- cmahalanobis(groups, plot = TRUE, p.value = TRUE)
distances
```

```{r}
group1 <- data.frame(a = c(1,2,NaN,4), b = c(3,4,5,NaN))
group2 <- data.frame(a = c(2,5,NaN,3), b = c(3,4,5,5))
groups <- list(group1, group2)
distances <- cmahalanobis(groups, plot = FALSE, p.value = TRUE)
distances
```

## Advantages on particular dataset 
The “cmahalanobis” package is particularly suitable for datasets that contain multiple groups of multivariate data for which you want to calculate the Mahalanobis distance. Here are some scenarios where “cmahalanobis” proves to be very useful:

* **Biodiversity analysis:** When you have measurements of different species and want to compare their genetic or ecological distances. An example is “iris” dataset.
*	**Quality control:** In industrial contexts, to compare groups of products or processes based on multiple quality metrics. An example is “mtcars” dataset.
*	**Medical research:** To compare groups of patients based on multiple health indicators or treatment responses. An example is “Human Connectome project” that aims to construct a map of the neural connections of the human brain. This type of dataset is crucial for studying the neurobiological basis of cognition and gaining a better understanding of neurological disorders.
* **Market analysis:** When analysing customer or product segments based on multiple demographic or behavioral characteristics. An example is “Real Estate Data Marketplace” that analyse the trend of real estate market when related to AI, Internet of Things (IoT), Big Data, Digital Object Identifiers (DOI) and Blockchain. This type of dataset includes real transacted data and can be used to study trends of real estate market; 
* **Pattern recognition:** In studies that require comparing groups of data to identify patterns or anomalies. An example is “MNIST database” that contains images of handwritten digits. It is widely used to train machine learning system for recognition of visual pattern and classification of images.

“cmahalanobis” is useful when you need a function that can automatically handles the calculation of means and covariance matrices for each group, simplifying the process of calculating distances between multiple groups. This makes it an excellent tool for analyses involving multi-group comparisons in a multivariate context.

## Application

### Application of cmahalanobis to the iris dataset
Once the download is successful, we can apply our function to the iris dataset which is a built-in dataset in R. The iris dataset contains 150 observations of three species of iris flowers (setosa, versicolor, and virginica), with four variables: sepal length, sepal width, petal length, and petal width. Before we can use our function, we have to create a list of data frames for each species, with the following code:

```{r}
iris_list <- split(iris, iris$Species)
```

This code splits the iris data frame into three data frames, one for each species, and stores them in a list called the “iris_list”. We can print the “iris_list” to visualize its structure and content:

```{r}
# Print iris_list
iris_list
```

Now that we have created our list of dataframes, we can apply the function “cmahalanobis()”.

```{r}
res <- cmahalanobis(iris_list, p.value = TRUE)
```

Then, we use:

```{r}
res
```

This code shows the Mahalanobis distance between each iris species present in the iris dataframe: setosa, versicolor and virginica. The main diagonal of the matrix shows the Mahalanobis distance between each species and itself, which is always 3.9. The other elements of matrix revealed the Mahalanobis distance between the different species. For example: the Mahalanobis distance between setosa and versicolor was 335.19989, instead between versicolor and virginica was 16.88654. This means that the versicolor and virginica species are more similar then the setosa species, according to the variables measured in the iris dataframe. The values in the rows, from 1 to 3, indicate the distance between the mean of that row's group and the mean of each group in the columns. For example, in [1,2], it represents the distance between the mean of group 1 and all points in group 2; in [3,2], it represents the mean of group 3 and all points in group 2, and so on.

Figure 1 shows the same results as those for the matrix, but graphically.

The p-value matrix that we have obtained by the application of our package to iris "dataset" supplies information statistically significant about Mahalanobis distance between groups of data. We have calculated p-values using chi-squared distribution. Here what p-values show:

* P-value under 0.05: A very small p-value (such as those we see in your matrix) indicates that the Mahalanobis distance between groups is statistically significant. In other words, the compared groups are significantly different from each other in terms of their measured characteristics.

* NA (Not Applicable): NA values on the diagonal indicate that a p-value has not been calculated for comparing a group with itself, as the p-value is meaningless when calculating the difference between a group and itself.

In summary, our p-value matrix suggests that all three groups in the 'iris' dataset are significantly different from each other based on the provided measurements. This is consistent with what one would expect from the 'iris' dataset, which contains measurements of three different species of iris flowers (setosa, versicolor, and virginica), each with distinctive characteristics.


### Application of cmahalanobis to the mtcars dataset
Now I will apply the function “cmahalanobis” to the mtcars dataset using the variable “am”. First, we have to split the data into 0, that is, automatic transmission, and 1, that is, manual transmission, thus:

```{r}
# Create a dataframe where only ”am = 0” is present
auto <- subset(mtcars, am == 0)
# Remove the variable ”am = 0”
auto <- auto [, -9]
# Create a dataframe where only ”am = 1” is present
manual <- subset(mtcars, am == 1)
# Remove the variable ”am = 1”
manual <- manual[, -9]
# Create a list with the two groups of cars
groups <- list(auto, manual)
```

Inside the vector groups:
```{r}
# Print groups
groups
```

Finally we apply:
```{r}
res <- cmahalanobis(groups, plot = TRUE, p.value = TRUE)
res
```

Figure 2 shows that the distance between the mean of factor 1 and all data of itself is 9.47, the same distance is 9.23 for factor 2. We observe that the distance between cars with “am = 0” and cars with “am = 1” is 156.11, under the perspective of “am = 0”. At "am = 1", the distance between the mean of this variable and all data of "am = 0" is 735.591909, which is high. Therefore, cars with “am = 1” and with “am = 0” are truly different considering other variables: that is, "mpg" "cyl" "disp" "hp" "drat" "wt" "qsec" "vs" "gear" and "carb". The p-value matrix, which values are significantly below 0.05, confirms it.

###	Simulation study
Here is an example of a simulation study using the “cmahalanobis” package in R. In this study, we generated three simulated data groups, each with a set of normally distributed variables, and then calculated the Mahalanobis distance between these groups using the “cmahalanobis” function.

```{r}
# Load cmahalanobis package
library(cmahalanobis)
# Define the number of observations and variables for each groups
num_observations <- 100
num_variables <- 5
# We generate three groups of simulated data with normal distribution
set.seed(123) # For the reproducibility of results
group1 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
group2 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
group3 <- as.data.frame(matrix(rnorm(num_observations * num_variables), 
                               nrow = num_observations))
# Create a list of three groups of data
groups <- list(group1, group2, group3)
# Calculate Mahalanobis distance with cmahalanobis function
distances <- cmahalanobis(groups, p.value = TRUE)
# Visualize the distance matrix
distances
```

In this script:

* We used “rnorm” to generate random data normally distributed for each group;
* We created a matrix for each group with  “num_observations” rows and “num_variables” columns;
* We converted each matrix into a dataframe and we stored them in a list;
* We used “cmahalanobis” function to calculate Mahalanobis distance between groups;
* We printed the resulting distance matrix, the plot and the p-value matrix.

The distances matrix shows Mahalanobis distance between the mean of each group on rows and all data on columns. P-value matrix shows only values above 0.05. So, distances are low and groups are slightly different.

This simulation study can serve as a starting point for more complex analyses, such as group comparisons in biodiversity studies, pattern analysis in multivariate data, or testing the effectiveness of statistical methods on simulated data. We advise that the results will be different each time you run the script due to the random nature of data generation, unless we set a fixed seed using “set.seed”.

## Conclusion
In this work, I have presented my package “cmahalanobis”, which I created to calculate the Mahalanobis distance between two or more groups of multivariate data. The Mahalanobis distance is a measure of dissimilarity between two vectors of multivariate random variables, based on the covariance matrix. This distance is useful for matching or statistical data fusion, i.e., integrating two data sources that refer to the same target population and share some variables. My main goal was to compare the Mahalanobis distances between different types of data and explore patterns and relationships in the data. To create and use my package “cmahalanobis”, I used the programming language R and followed the guidelines for writing R packages provided by CRAN. I implemented my function “cmahalanobis”, which takes a list of data frames as input and returns a matrix with the Mahalanobis distances between the dataframes, plot and p-value matrix. I also created documentation for my package using the “roxygen2” package. To apply my function “cmahalanobis”, I used three datasets: iris, mtcars, and simulated dataset. The iris dataset contains measurements of sepal and petal length and width for three species of iris. The mtcars dataset contains the characteristics of 32 cars, including the type of transmission. The results showed that the Mahalanobis distance between different types of data varied depending on the considered variables and the direction of comparison. For example, in the iris dataset, the highest distance concern the mean of setosa and all data of virginica; the lowest distance with same statistics concerns virginica and versicolor, respectively. In the mtcars dataset, the Mahalanobis distance between cars with automatic and manual transmission significantly differs, indicating a strong dissimilarity between the two types of cars based on the other measured variables. The simulation study showed the functioning of the package on random data. My conclusions are that the Mahalanobis distance is a useful metric for matching or statistical data fusion because it accounts for variable correlations and ellipsoidal data shapes.



